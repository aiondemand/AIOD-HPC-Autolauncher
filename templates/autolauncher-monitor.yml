variables:
    LAUNCH_TARGET_USERNAME: hpai
    LAUNCH_TARGET_HOSTNAME: amdlogin.bsc.es
    LAUNCH_TARGET_SSH_KEY: some_file
    LAUNCH_TARGET_FOLDER: /gpfs/projects/bsc70/hpai/storage/data/tests/
    LAUNCH_VERSION: ${CI_PROJECT_NAME}-${CI_COMMIT_SHORT_SHA}-${CI_COMMIT_REF_NAME}
    KNOWN_HOSTS_FILE: some_file
    AUTOLAUNCHER_VERSION: main
    LAUNCH_DESTINATION: ${LAUNCH_TARGET_USERNAME}@${LAUNCH_TARGET_HOSTNAME}
    JOB_WORKDIR: ${LAUNCH_TARGET_FOLDER}/jobs/${LAUNCH_VERSION}

monitor:
  image: ci.atalaya.at/containers/docker:stable
  stage: monitor
  dependencies:
    - launch
  script:
    - 'echo "Target server: ${LAUNCH_TARGET_USERNAME}@${LAUNCH_TARGET_HOSTNAME}"'
    - 'echo "SSH key path: ${LAUNCH_TARGET_SSH_KEY}"'
    - mkdir -p ~/.ssh/
    - cp ${KNOWN_HOSTS_FILE} ~/.ssh/known_hosts
    - cp ${LAUNCH_TARGET_SSH_KEY} ~/.ssh/ssh-key
    - chmod 0600 /root/.ssh/ssh-key
    - apk add openssh-client git
    - JOB_PID=`cat autolauncher.out | grep Submitted | cut -d ' ' -f 11 | egrep -o '[0-9.]+'`
    - echo "The job pid is $JOB_PID"
    - git clone -b "${AUTOLAUNCHER_VERSION}" --depth 1 https://gitlab-ci-token:${CI_JOB_TOKEN}@gitlab.hpai.bsc.es/hpai/autolauncher.git /tmp/autolauncher
    - scp -i /root/.ssh/ssh-key /tmp/autolauncher/monitor.sh ${LAUNCH_DESTINATION}:${JOB_WORKDIR}/monitor.sh
    - ssh -i /root/.ssh/ssh-key -o ServerAliveInterval=60 ${LAUNCH_DESTINATION} env JOB_PID=${JOB_PID} JOB_WORKDIR=${JOB_WORKDIR} bash ${JOB_WORKDIR}/monitor.sh
    - scp -i /root/.ssh/ssh-key ${LAUNCH_DESTINATION}:${JOB_WORKDIR}/output/*_${JOB_PID}_err.txt .
    - scp -i /root/.ssh/ssh-key ${LAUNCH_DESTINATION}:${JOB_WORKDIR}/output/*_${JOB_PID}_out.txt .
    - 'cat *_out.txt'
  artifacts:
    paths:
      - "*_err.txt"
      - "*_out.txt"
  rules:
    - if: '$LAUNCH_TARGET_HOSTNAME =~ /^mini.*$/'
      when: never
    - if: '$CI_COMMIT_TITLE =~ /^LAUNCH.*$/'
    - if: '$LAUNCH == "LAUNCH"'
      when: on_success
    - when: never

monitor_mini:
  image: ci.atalaya.at/containers/docker:stable
  stage: monitor
  dependencies:
    - launch_mini
  script:
    - 'echo "Target server: ${LAUNCH_TARGET_USERNAME}@${LAUNCH_TARGET_HOSTNAME}"'
    - apk add git python3 bash
    - JOB_PID=`cat job.pid | tail -n 1 | egrep -o '[0-9a-f.]+' | tail -n 1 | cut -c 1-12`
    - echo "The job pid is $JOB_PID"
    - git clone -b "${AUTOLAUNCHER_VERSION}" --depth 1 https://gitlab-ci-token:${CI_JOB_TOKEN}@gitlab.hpai.bsc.es/hpai/autolauncher.git /tmp/autolauncher
    - env JOB_PID=${JOB_PID} JOB_WORKDIR=${JOB_WORKDIR} bash /tmp/autolauncher/monitor_mini.sh
    - mkdir /tmp/autolauncher-output
    - docker cp -a ${JOB_PID}:${JOB_WORKDIR}/output /tmp/autolauncher-output
    - 'cat /tmp/autolauncher-output/*_out.txt'
  artifacts:
    paths:
      - /tmp/autolauncher-output
  rules:
    - if: '$CI_COMMIT_TITLE =~ /^LAUNCH.*$/ && $LAUNCH_TARGET_HOSTNAME =~ /^mini.*$/'
    - if: '$LAUNCH == "LAUNCH"'
      when: on_success
    - when: never
