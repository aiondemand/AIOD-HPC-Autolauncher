variables:
    LAUNCH_TARGET_HOSTNAME: amdlogin.bsc.es
    LAUNCH_TARGET_USERNAME: hpai
    LAUNCH_TARGET_FOLDER: /gpfs/projects/bsc70/hpai/storage/data/tests/
    LAUNCH_TARGET_SSH_KEY: some_file
    LAUNCH_CONFIG_PATH: configs/config.json
    KNOWN_HOSTS_FILE: some_file
    SINGULARITY_VERSION: 3.4.1

transfer:
  image: docker:stable
  stage: transfer
  script:
    - 'echo "Target server: ${LAUNCH_TARGET_USERNAME}@${amd}"'
    - time apk add openssh-client rsync
    - time docker run --rm --name isomorph-${CI_COMMIT_SHORT_SHA}-${CI_COMMIT_REF_NAME}
      -e SINGULARITY_DOCKER_USERNAME=gitlab-ci-token -e SINGULARITY_DOCKER_PASSWORD=${CI_BUILD_TOKEN}
      -e DESTINATION="${LAUNCH_TARGET_USERNAME}@${LAUNCH_TARGET_HOSTNAME}"
      -v ${SSH_KEY}:/tmp/ssh-key:Z -e CI_COMMIT_SHORT_SHA=${CI_COMMIT_SHORT_SHA} -e CI_COMMIT_REF_NAME=${CI_COMMIT_REF_NAME}
      --entrypoint '' -v /var/run/docker.sock:/var/run/docker.sock
      --mount source=singularity,target=/root/.singularity
      quay.io/singularity/singularity:v${SINGULARITY_VERSION}-slim sh -c
      'singularity build --sandbox /tmp/container/ "docker://ci.atalaya.at/${CI_PROJECT_PATH}:${CI_COMMIT_SHORT_SHA}-${CI_COMMIT_REF_NAME}" &&
      apk add rsync openssh-client &&
      rsync -azuh --del -e "ssh -i /tmp/ssh-key" /tmp/container/
      ${DESTINATION}:"${LAUNCH_TARGET_FOLDER}/containers/isomorphy-${CI_COMMIT_SHORT_SHA}-${CI_COMMIT_REF_NAME}/"'
    - export JOB_WORKDIR=${LAUNCH_TARGET_FOLDER}/jobs/${CI_COMMIT_SHORT_SHA}-${CI_COMMIT_REF_NAME}/
    - time ssh -i ${LAUNCH_TARGET_SSH_KEY} ${LAUNCH_TARGET_USERNAME}@${LAUNCH_TARGET_HOSTNAME} mkdir -p ${JOB_WORKDIR}/
    - time rsync -azuh --del -e "ssh -i ${LAUNCH_TARGET_SSH_KEY}" src/ ${LAUNCH_TARGET_USERNAME}@${LAUNCH_TARGET_HOSTNAME}:${JOB_WORKDIR}/src/
    - time scp -i ${LAUNCH_TARGET_SSH_KEY} ${LAUNCH_CONFIG_PATH} ${LAUNCH_TARGET_USERNAME}@${LAUNCH_TARGET_HOSTNAME}:${JOB_WORKDIR}/
    - wget https://gitlab.hpai.bsc.es/hpai/autolauncher/-/raw/main/autolauncher.py
    - time scp -i ${LAUNCH_TARGET_SSH_KEY} ${LAUNCH_TARGET_USERNAME}@${LAUNCH_TARGET_HOSTNAME}:${JOB_WORKDIR}/
  rules:
    - if: '$CI_COMMIT_TITLE =~ /^LAUNCH.*$/'
      when: on_success
    - when: never
