variables:
    LAUNCH_TARGET_FOLDER: /gpfs/projects/bsc70/hpai/storage/data/tests/
    LAUNCH_IMAGE_NAME: ${CI_PROJECT_PATH}:${CI_COMMIT_SHORT_SHA}-${CI_COMMIT_REF_NAME}
    LAUNCH_CONFIG_PATH: configs/config.json
    EXEC_HOSTS_FILE: some_file
    REQUIREMT_FILE: requirements.txt
    LAUNCH_VERSION: ${CI_PROJECT_NAME}-${CI_COMMIT_SHORT_SHA}-${CI_COMMIT_REF_NAME} # qi
    TAGS: estufa # mininostrum, estufa or pepino

build:
  image: ci.atalaya.at/containers/docker:stable
  stage: build
  before_script:
    - apk add --update curl && rm -rf /var/cache/apk/*
    - time apk add bash
  script:
    - export LAUNCH_IMAGE_NAME=$(env LAUNCH_IMAGE_NAME=${LAUNCH_IMAGE_NAME} bash -c 'echo ${LAUNCH_IMAGE_NAME,,}')
    - >-
      echo -e "[global]\ntimeout = 60\nindex-url = https://pypi.org/simple\ntrusted-host = pypi.org\n               hpai.bsc.es\nextra-index-url = https://${pypi_user}:${pypi_pass}@hpai.bsc.es:11080/simple/\n" > pip.conf
    - docker login -u gitlab-ci-token -p ${CI_JOB_TOKEN} ci.atalaya.at
    - docker build -t ci.atalaya.at/${LAUNCH_IMAGE_NAME} -f containers/Dockerfile-${LAUNCH_TARGET}${DOCKERFILE_TAG} .
    - docker push ci.atalaya.at/${LAUNCH_IMAGE_NAME}
  rules:
    - if: $CI_COMMIT_TITLE =~ /^LAUNCH_AMD.*$/
      variables:
        LAUNCH_TARGET: amd
    - if: $CI_COMMIT_TITLE =~ /^LAUNCH_MN4.*$/
      variables:
        LAUNCH_TARGET: mn4
    - if: $CI_COMMIT_TITLE =~ /^LAUNCH_LOCAL.*$/
      variables:
        LAUNCH_TARGET: local
    - when: never
  tags: 
    - ${TAGS}


build_image_mn5:
  # Usamos la imagen de Singularity como base
  image: 
    name: quay.io/singularity/singularity:v3.11.5-slim
    entrypoint: [""]
  stage: build
  services:
    - docker:dind
  variables:
    DOCKER_DRIVER: overlay2
  before_script:
    - | 
        apk add --update curl && rm -rf /var/cache/apk/*
        time apk add bash
        apk add python3 py3-pip
        pip3 install sregistry[all]
  script:
    # Step 1: extract the image name from the commit title
    - export BUILD_IMAGE_NAME=$(echo ${CI_COMMIT_TITLE} | sed -e 's/.*<\([^]]*\)>.*/\1/g')
    - echo "The new image is $BUILD_IMAGE_NAME"

    # Step 2: Remove namespace project path from string
    - BUILDING_IMAGE_NAME=${LAUNCH_IMAGE_NAME#"$CI_PROJECT_NAMESPACE/"}
    
    # Step 3: Prepare the working directory
    - JOB_WORKDIR=${LAUNCH_TARGET_FOLDER}/${CI_PROJECT_PATH}
    - | 
        mkdir -p ${JOB_WORKDIR}/autolauncher-output
        cp ${REQUIREMT_FILE} ${JOB_WORKDIR}/autolauncher-output
        cd ${JOB_WORKDIR}/autolauncher-output

    # Step 4: do the pull of the image on the host
    - singularity pull docker://${BUILD_IMAGE_NAME}

    # Step 5: Build the Singularity image in sandbox mode
    - singularity build --force --sandbox ${JOB_WORKDIR}/${BUILDING_IMAGE_NAME} docker://${BUILD_IMAGE_NAME}

    # step 6: copy the requirement file to the singularity container (--nv)
    - cp ${REQUIREMT_FILE} ${JOB_WORKDIR}/${BUILDING_IMAGE_NAME}/tmp/$REQUIREMT_FILE

    # steo 7: run pip install inside the sigularity image
    - singularity exec --writable --nv ${JOB_WORKDIR}/${BUILDING_IMAGE_NAME} /bin/sh -c "pip install -r /tmp/$REQUIREMT_FILE"

    # step 8: run the command inside the singularity container
    - singularity exec --writable --nv ${JOB_WORKDIR}/${BUILDING_IMAGE_NAME} /bin/sh -c "pip freeze > pip_freeze.txt"

    # step 9: convert to sif format
    - singularity build ${JOB_WORKDIR}/${BUILDING_IMAGE_NAME}.sif ${JOB_WORKDIR}/${BUILDING_IMAGE_NAME}

    # Step 10: pull the singularity image to the singularity registry
    # - sregistry push --name ${LAUNCH_IMAGE_NAME} ${JOB_WORKDIR}/${LAUNCH_IMAGE_NAME}

    # Step 10a: pull the singulaity image to the docker registry
    - singularity build --docker-login --remote docker://${LAUNCH_IMAGE_NAME} ${JOB_WORKDIR}/${BUILDING_IMAGE_NAME}
  artifacts:
    paths:
      - autolauncher-output/output
    expire_in: 1 week
  rules:
    - if: $CI_COMMIT_TITLE =~ /^BUILD_IMAGE_MN5.*$/
    - when: never
  tags:
    - estufa

update_image_mn5:
  image:
    name: quay.io/singularity/singularity:v3.11.5-slim
    entrypoint: [""]
  stage: build
  script:
    # get image to use from commit title
    - export UPDATE_IMAGE_NAME=$(echo ${CI_COMMIT_TITLE} | sed -e 's/.*<\([^]]*\)>.*/\1/g')
    - 'echo "The update image is: $UPDATE_IMAGE_NAME"'
    
    # Define the working directory
    - JOB_WORKDIR=${LAUNCH_TARGET_FOLDER}/${CI_COMMIT_SHORT_SHA}
    - mkdir -p ${JOB_WORKDIR}/autolauncher-output && cd ${JOB_WORKDIR}/autolauncher-output

    # step 1: download from path
    - singularity build --sandbox ${JOB_WORKDIR}/${UPDATE_IMAGE_NAME} docker://${UPDATE_IMAGE_NAME}

    # step 2: copy the install.sh script to the singularity container
    - cp ./$EXEC_HOSTS_FILE /tmp/$EXEC_HOSTS_FILE

    # step 3: run the install.sh script
    - singularity exec --writable ${JOB_WORKDIR}/${UPDATE_IMAGE_NAME} /bin/sh /tmp/$EXEC_HOSTS_FILE

    # step 4: check the installed packages
    - singularity exec ${JOB_WORKDIR}/${UPDATE_IMAGE_NAME} dpkg -l > installed_packages.txt
  artifacts:
    paths:
      - autolauncher-output/output
    expire_in: 1 week
  rules:
    - if: $CI_COMMIT_TITLE =~ /^UPDATE_IMAGE_MN5.*$/
    - when: never
  tags:
    - privileged
    - estufa
